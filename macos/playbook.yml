---
- name: Install software
  hosts: local
  become: false
  vars:
    workspace_directory: "{{ ansible_env.HOME }}/workspace"
    personal_directory: "{{ ansible_env.HOME }}/workspace/personal"
    work_directory: "{{ ansible_env.HOME }}/workspace/work"
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_architecture == 'arm64' else '/usr/local' }}"
    node_versions:
      - version: 16.16.0
      - version: 18.14.2
      - version: 20.9.0
        default: true
    python_versions:
      - version: 3.10.6
      - version: 3.11.4
        default: true
    java_versions:
      - version: openjdk@11
      - version: openjdk@17
        default: true
      - version: openjdk@21
      - version: openjdk@25
    neovim_version: "neovim@0.11"  # Pinned to 0.11.x
  
  tasks:
    # Prerequisites (must run first)
    - name: Install Prerequisites
      community.general.homebrew:
        name:
          - stow
          - git
          - curl
          - httpie
        state: present
      tags:
        - homebrew
        - prerequisites

    # Workspace directories
    - name: Setup workspace directories
      include_tasks: tasks/workspace.yml
      tags:
        - workspace

    # Dotfiles
    - name: Setup dotfiles
      include_tasks: tasks/dotfiles.yml
      tags:
        - dotfiles

    # Shell (zsh, oh-my-zsh, plugins)
    - name: Setup shell
      include_tasks: tasks/shell.yml
      tags:
        - shell
        - zsh

    # Homebrew packages and casks
    - name: Install Homebrew packages
      include_tasks: tasks/homebrew.yml
      tags:
        - homebrew

    # Programming languages (Java, Node, Python)
    - name: Setup programming languages
      include_tasks: tasks/languages.yml
      tags:
        - languages

    # Development tools (tmux, neovim)
    - name: Setup development tools
      include_tasks: tasks/dev-tools.yml
      tags:
        - dev-tools

    # Configuration files (maven, pip, npm)
    - name: Setup configuration files
      include_tasks: tasks/config-files.yml
      tags:
        - config

    # Prompt for machine type (needed for git and work tasks)
    - name: Prompt for machine type
      pause:
        prompt: "Enter machine type (work/personal)"
      register: machine_type
      tags:
        - git
        - ssh
        - work

    # Git configuration and SSH
    - name: Setup Git and SSH
      include_tasks: tasks/git.yml
      tags:
        - git
        - ssh

    # Work-specific tasks
    - name: Setup work-specific configuration
      include_tasks: tasks/work.yml
      when: machine_type.user_input == "work"
      tags:
        - work
